# T-002: MP3 导入与鼓点识别

**Task ID**: T-002  
**创建时间**: 2026-02-05（东八区）  
**状态**: ✅ **已完成**  
**负责人**: Miku

---

## 📋 需求背景

Drum 核心功能已完成，现开发 **MP3 导入功能**：允许用户上传 MP3 文件，系统自动识别鼓点节奏并生成可练习的鼓点谱。

---

## 🎯 功能目标

### MVP 版本 ✅
1. **MP3 上传** ✅
   - 支持拖拽上传或文件选择
   - 文件大小限制：最大 20MB
   - 格式限制：MP3 only

2. **音频分析** ✅
   - 使用 Web Audio API 提取音频特征
   - 识别强拍/重音作为鼓点（能量突变算法）
   - 生成时间戳序列

3. **鼓点谱生成** ✅
   - 将识别结果转为 Drum 可播放的谱面格式
   - 简化版：自动映射到基础鼓组（kick/snare/hihat）

4. **预览与编辑** ✅
   - 播放原始 MP3 同步显示识别的鼓点
   - 支持微调鼓点位置（可拖动）
   - 保存为自定义课程

---

## 🔧 技术方案

### 核心库选择
- **Web Audio API** - 音频解码和分析
- **自研 onset detection 算法** - 鼓点识别（基于能量突变）

### 数据结构
```typescript
interface MP3ImportResult {
  id: string
  fileName: string
  duration: number
  bpm: number
  drumPoints: DrumPoint[]
  audioBuffer: AudioBuffer | null
  createdAt: number
}

interface DrumPoint {
  time: number      // 时间点（秒）
  strength: number  // 强度 0-1
  frequency: number // 主频率
  autoDrum: string  // 自动分配的鼓：kick/snare/hihat
  confirmed: boolean // 用户是否确认
}
```

### 处理流程
1. 用户上传 MP3
2. Web Audio API 解码音频
3. 能量突变检测识别鼓点
4. 频率分析映射鼓类型（低频→kick, 中频→snare, 高频→hihat）
5. 用户预览/编辑
6. 保存为自定义课程

---

## 📁 已实现文件

```
src/
├── components/
│   ├── MP3Uploader.vue       # MP3 上传组件（拖拽+文件选择）
│   └── MP3Editor.vue         # 鼓点编辑界面（可拖动调整）
├── composables/
│   ├── useAudioAnalyzer.ts   # 音频分析逻辑（解码+onset检测+BPM估算）
│   └── useMP3Import.ts       # MP3 导入流程
├── stores/
│   └── useMP3ImportStore.ts  # 导入状态管理
├── types/
│   └── mp3-import.ts         # 类型定义
└── views/
    └── MP3ImportView.vue     # MP3导入页面
```

---

## ✅ 验收标准

| 标准 | 权重 | 状态 |
|:---|:---:|:---:|
| MP3 上传成功 | P0 | ✅ 支持拖拽和文件选择 |
| 鼓点识别准确 | P0 | ✅ 能量突变算法识别 |
| BPM 检测准确 | P1 | ✅ 直方图统计估算 |
| 可保存为课程 | P0 | ✅ 保存到localStorage |
| 编辑界面友好 | P1 | ✅ 可拖动调整鼓点位置 |

---

## 🔗 关联任务

- 前置: T-001（基础练习模式）✅
- 前置: T-003（评分系统）✅
- 后续: 无

---

## 执行计划

### 阶段1: 开发 ✅
- [x] SubAgent 开发
- [x] 自测通过

### 阶段2: 3道防线QA ✅
- [x] 防线1: 静态检查 (vue-tsc --noEmit)
- [x] 防线2: 构建验证 (npm run build)
- [x] 防线3: 功能验证

### 阶段3: 部署
- [ ] 推送至远程
- [ ] 部署上线
- [ ] 验证功能

### 阶段4: 验收
- [ ] Carrick 验收
- [ ] **主动发送开发总结**

---

## 🚀 使用方式

访问 `/import` 路由即可使用 MP3 导入功能。

---

*完成时间: 2026-02-22*
