# T-004: 解锁机制实现

## 基本信息
| 字段 | 值 |
|------|-----|
| Task ID | T-004 |
| 名称 | 解锁机制实现 |
| 状态 | ⏳ 待开发 |
| 优先级 | P1 - 重要功能 |
| 负责人 | 待定 |
| 创建日期 | 2026-02-10 |
| 预计完成 | 待定 |

---

## 📋 任务描述

为Drum App实现课程解锁机制，用户需要完成前置课程达到一定评级才能解锁后续课程，形成渐进式学习体验。

---

## 🎯 任务目标

1. **前置课程机制** - 实现课程依赖关系
2. **评级解锁** - 设定解锁所需的最低评级
3. **视觉反馈** - 锁定/解锁状态的UI展示
4. **引导提示** - 解锁条件的友好提示

---

## ✅ 子任务清单

### 1. 解锁规则设计
- [ ] **线性解锁机制**
  - 完成当前课程即可解锁下一课
  - 可选：设置最低评级要求
- [ ] **评级要求**
  - 入门课程：完成即可
  - 初级课程：前一课评级≥C
  - 中级课程：前一课评级≥B
  - 进阶课程：前一课评级≥A
- [ ] **批量解锁（可选）**
  - 完成某难度所有课程解锁下一难度

### 2. 解锁状态管理
- [ ] **状态存储**
  - localStorage存储每首课程的解锁状态
  - 记录每首课程的最高评级
- [ ] **状态计算**
  - 启动时计算所有课程解锁状态
  - 实时更新解锁状态
- [ ] **首次解锁检测**
  - 检测新解锁的课程
  - 触发解锁动画/提示

### 3. 课程选择器UI
- [ ] **锁定状态展示**
  - 锁图标覆盖
  - 半透明/灰度显示
  - 点击弹出解锁提示
- [ ] **解锁状态展示**
  - 高亮显示
  - 完成标记（已完成的课程）
  - 最佳评级显示
- [ ] **解锁动画**
  - 解锁时的过渡动画
  - 庆祝效果（可选）
- [ ] **解锁提示弹窗**
  - 显示解锁条件
  - "去练习"按钮跳转

### 4. 解锁流程
- [ ] **课程完成检测**
  - 课程结束时检查评级
  - 判断是否满足解锁条件
- [ ] **解锁事件触发**
  - 检测到新课程解锁
  - 触发解锁庆祝流程
- [ ] **引导体验**
  - 解锁后提示用户继续
  - 展示下一课预览

---

## 🔧 技术要点

### 解锁规则配置
```typescript
// 课程解锁规则
interface UnlockRule {
  lessonId: string;
  requiredLessons: Array<{
    lessonId: string;
    minRating?: 'S' | 'A' | 'B' | 'C' | 'D' | null;
  }>;
}

// 课程元数据扩展
interface LessonMetadata {
  id: string;
  name: string;
  difficulty: 'beginner' | 'elementary' | 'intermediate' | 'advanced';
  unlockRule: UnlockRule;
  prerequisites: string[];
}

// 课程完成记录
interface LessonProgress {
  lessonId: string;
  isUnlocked: boolean;
  isCompleted: boolean;
  bestRating: 'S' | 'A' | 'B' | 'C' | 'D' | null;
  bestScore: number;
  completedAt: number | null;
}
```

### 解锁规则表
```typescript
const UNLOCK_RULES: UnlockRule[] = [
  { lessonId: 'L-001', requiredLessons: [] }, // 第一首默认解锁
  { lessonId: 'L-002', requiredLessons: [{ lessonId: 'L-001', minRating: null }] },
  { lessonId: 'L-003', requiredLessons: [{ lessonId: 'L-002', minRating: 'C' }] },
  { lessonId: 'L-004', requiredLessons: [{ lessonId: 'L-003', minRating: 'C' }] },
  { lessonId: 'L-005', requiredLessons: [{ lessonId: 'L-004', minRating: 'B' }] },
  { lessonId: 'L-006', requiredLessons: [{ lessonId: 'L-005', minRating: 'B' }] },
  { lessonId: 'L-007', requiredLessons: [{ lessonId: 'L-006', minRating: 'B' }] },
  { lessonId: 'L-008', requiredLessons: [{ lessonId: 'L-007', minRating: 'A' }] },
  { lessonId: 'L-009', requiredLessons: [{ lessonId: 'L-008', minRating: 'A' }] },
  { lessonId: 'L-010', requiredLessons: [{ lessonId: 'L-009', minRating: 'A' }] },
];
```

### 解锁检查逻辑
```typescript
function checkUnlockStatus(
  lessonId: string,
  progress: Record<string, LessonProgress>
): boolean {
  const rule = UNLOCK_RULES.find(r => r.lessonId === lessonId);
  if (!rule || rule.requiredLessons.length === 0) {
    return true; // 无依赖，默认解锁
  }
  
  return rule.requiredLessons.every(req => {
    const reqProgress = progress[req.lessonId];
    if (!reqProgress?.isCompleted) return false;
    if (!req.minRating) return true;
    
    const ratingOrder = ['D', 'C', 'B', 'A', 'S'];
    const achievedIdx = ratingOrder.indexOf(reqProgress.bestRating || 'D');
    const requiredIdx = ratingOrder.indexOf(req.minRating);
    return achievedIdx >= requiredIdx;
  });
}
```

---

## 📁 相关文件

```
src/
├── components/
│   ├── LessonSelector.vue     # 课程选择器（需修改）
│   ├── LessonCard.vue         # 课程卡片组件
│   ├── LockOverlay.vue        # 锁定覆盖层
│   ├── UnlockModal.vue        # 解锁提示弹窗
│   └── UnlockCelebration.vue  # 解锁庆祝动画
├── stores/
│   └── useProgressStore.ts    # 进度管理Store
├── data/
│   └── unlockRules.ts         # 解锁规则配置
└── composables/
    └── useUnlock.ts           # 解锁逻辑Hook
```

---

## ✅ 验收标准

| 标准 | 状态 | 说明 |
|------|------|------|
| 课程依赖正确 | ⏳ | 完成前置才能解锁后续 |
| 评级要求生效 | ⏳ | 未达到评级无法解锁 |
| 锁定UI清晰 | ⏳ | 用户能识别锁定状态 |
| 解锁提示友好 | ⏳ | 清楚说明解锁条件 |
| 解锁动画流畅 | ⏳ | 解锁时有视觉反馈 |
| 状态持久化 | ⏳ | 刷新后解锁状态保留 |

---

## 📝 CTT提交规范

```
feat(drum): T-004 解锁机制实现

- 关键任务: 1）解锁规则 2）状态管理 3）UI反馈
- 状态: 🔄进行中
- 团队: 🎨Lyra(主力)
```

---

## 🔗 关联任务

- 前置: T-001（教学模式与判定系统）
- 前置: T-002（10首练习曲库）
- 前置: T-003（评分系统开发）
- 后续: 无
- 依赖: T-001, T-002, T-003

---

**状态:** ⏳ 待开发 | **阻塞:** 等待T-002, T-003完成
