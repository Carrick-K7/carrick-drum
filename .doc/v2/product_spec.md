# Drum App Phase 5 V2: 教学模式 + MP3识别 - Product Spec

> **PTT Version**: 2.0  
> **Last Updated**: 2026-02-08  
> **Status**: Ready for Development  
> **Phase**: 5 (Teaching Mode + MP3 Recognition)

---

## 1. Core Concept (核心价值)

### 1.1 Product Vision
Drum Phase 5 V2 将教学模式与AI音频识别结合，打造**零基础到实战**的完整学习闭环：
- **教学模式**: 渐进式节奏练习，实时反馈纠错
- **MP3识别**: 导入任意歌曲，自动生成鼓谱练习

### 1.2 Core Value Proposition
- **零门槛入门**: 无需乐理，跟随视觉引导即可开始
- **任意歌曲练习**: 上传MP3，AI自动生成可练习的鼓谱
- **即时成就感**: 实时判定反馈 + 游戏化评分系统
- **科学进阶**: 10首基础曲目 + 无限自定义曲目

### 1.3 Visual Vibe
- **风格**: 现代暗色主题，霓虹光效
- **色彩语言**: 
  - 🔴 即将敲击 (警告/准备)
  - 🟡 准备敲击 (提示)
  - 🟢 精确敲击 (成功)
  - ✨ Combo高亮 (金色渐变)
  - 🎵 MP3波形可视化 (青色)
- **动效**: 鼓垫脉动、光晕扩散、飘字动画、波形跳动

---

## 2. Feature Modules (功能模块)

### Module A: 教学模式 (Teaching Mode) - P0

#### A.1 练习曲系统
| Feature | Description | Priority | AC ID |
|---------|-------------|----------|-------|
| 10首内置曲目 | 初级3首(60-70BPM)、中级4首(80-100BPM)、高级3首(110-120BPM) | P0 | AC-001 |
| 节奏数据 | 每首曲目的精确时间映射(drumId + time) | P0 | AC-002 |
| 渐进解锁 | C级解锁下一首，平均B级解锁中级，平均A级解锁高级 | P0 | AC-003 |
| 速度档位 | 慢速(0.75x)、标准(1.0x)、快速(1.25x)渐进解锁 | P0 | AC-004 |

#### A.2 判定系统
| Feature | Description | Priority | AC ID |
|---------|-------------|----------|-------|
| 时间窗口判定 | PERFECT(±50ms)、GOOD(±100ms)、MISS(>±150ms) | P0 | AC-005 |
| 最近音符匹配 | 200ms窗口内查找最近期望音符 | P0 | AC-006 |
| 漏击检测 | 超过时间窗口未敲击自动记MISS | P0 | AC-007 |
| 判定反馈 | 鼓件颜色闪烁 + 飘字动画 | P0 | AC-008 |

#### A.3 评分系统
| Feature | Description | Priority | AC ID |
|---------|-------------|----------|-------|
| 准确率计算 | (Perfect×1.0 + Good×0.7) / 总数 × 100% | P0 | AC-009 |
| Combo系统 | 连续正确递增，MISS重置 | P0 | AC-010 |
| Combo加成 | 10+(×1.1)、30+(×1.2)、50+(×1.5)、100+(×2.0) | P0 | AC-011 |
| 评级系统 | S(≥95%)、A(≥85%)、B(≥70%)、C(≥50%)、D(<50%) | P0 | AC-012 |

#### A.4 视觉引导
| Feature | Description | Priority | AC ID |
|---------|-------------|----------|-------|
| 倒计时引导 | 3-2-1-GO全屏动画 | P0 | AC-013 |
| 鼓点提示 | 提前500ms显示高亮 | P0 | AC-014 |
| 节拍器显示 | 4/4拍视觉指示器 | P1 | AC-015 |
| 实时反馈 | 正确/错误视觉反馈 | P0 | AC-016 |

#### A.5 进度存储
| Feature | Description | Priority | AC ID |
|---------|-------------|----------|-------|
| 本地持久化 | localStorage存储进度 | P0 | AC-017 |
| 最佳记录 | 每首曲目的最佳评级/准确率/Combo | P0 | AC-018 |
| 数据版本 | 版本号控制，向后兼容 | P0 | AC-019 |

---

### Module B: MP3鼓点识别 (MP3 Recognition) - P0

#### B.1 音频上传与预处理
| Feature | Description | Priority | AC ID |
|---------|-------------|----------|-------|
| 文件选择 | 支持MP3/WAV格式，最大20MB | P0 | AC-020 |
| 音频解码 | 使用Web Audio API解码音频数据 | P0 | AC-021 |
| 波形预览 | 显示音频波形图，支持选择练习段落 | P1 | AC-022 |
| 元数据读取 | 读取ID3标签(标题、艺术家、BPM) | P2 | AC-023 |

#### B.2 AI鼓点检测
| Feature | Description | Priority | AC ID |
|---------|-------------|----------|-------|
|  onset检测 | 检测音频中的瞬态 onset 事件 | P0 | AC-024 |
| 鼓点分类 | 将onset分类为 Kick/Snare/HiHat/Crash/Tom | P0 | AC-025 |
| BPM检测 | 自动检测歌曲BPM | P0 | AC-026 |
| 节奏网格对齐 | 将检测到的鼓点对齐到节拍网格 | P1 | AC-027 |
| 置信度阈值 | 只保留高置信度(>0.7)的检测结果 | P0 | AC-028 |

#### B.3 生成练习谱
| Feature | Description | Priority | AC ID |
|---------|-------------|----------|-------|
| 自动映射 | 将检测结果转换为TeachingRhythmMap格式 | P0 | AC-029 |
| 难度分级 | 根据密度自动分级(简单<50音符/分钟) | P1 | AC-030 |
| 段落选择 | 用户可选择练习整首或30秒片段 | P1 | AC-031 |
| 保存到本地 | 生成的谱面保存到localStorage | P0 | AC-032 |

#### B.4 识别结果编辑
| Feature | Description | Priority | AC ID |
|---------|-------------|----------|-------|
| 可视化编辑 | 在时间轴上显示/编辑检测到的鼓点 | P2 | AC-033 |
| 手动添加 | 支持手动添加遗漏的鼓点 | P2 | AC-034 |
| 删除误检 | 支持删除错误检测的鼓点 | P2 | AC-035 |
| 重新识别 | 调整阈值后重新运行检测 | P2 | AC-036 |

---

### Module C: 增强功能 - P1

#### C.1 音频节拍器
| Feature | Description | Priority | AC ID |
|---------|-------------|----------|-------|
| 音频节拍器 | 第一拍高音、其他拍低音 | P1 | AC-037 |
| 原唱开关 | 练习时可开关原唱 | P1 | AC-038 |

#### C.2 结算与分享
| Feature | Description | Priority | AC ID |
|---------|-------------|----------|-------|
| 详细结算 | Perfect/Good/Miss统计 + 波形命中率 | P1 | AC-039 |
| 新记录提示 | 打破记录时高亮显示 | P1 | AC-040 |
| 练习报告 | 生成可分享的练习报告图 | P2 | AC-041 |

---

## 3. Acceptance Criteria (验收标准)

### AC-001 ~ AC-004: 练习曲系统
```gherkin
AC-001: 内置曲目完整性
  Given 用户进入教学模式
  When 查看练习曲列表
  Then 应显示10首曲目，分为初级(1-3)、中级(4-7)、高级(8-10)
  And 每首曲目显示标题、BPM范围、难度标签

AC-002: 节奏数据准确性
  Given 一首练习曲的节奏数据
  When 解析beats数组
  Then 每个beat包含time(秒)、drumId、type字段
  And 时间戳按升序排列
  And 相邻音符时间差 >= 100ms (避免重叠)

AC-003: 渐进解锁机制
  Given 用户完成初级第1首
  When 获得C级以上评级
  Then 初级第2首自动解锁
  And 锁图标变为可点击状态

AC-004: 速度档位解锁
  Given 一首新解锁的练习曲
  When 查看速度选项
  Then 慢速(0.75x)默认解锁
  And 标准速度需慢速达到C级解锁
  And 快速需标准速度达到B级解锁
```

### AC-005 ~ AC-008: 判定系统
```gherkin
AC-005: 时间窗口判定精度
  Given 当前练习进行中
  When 用户在期望时间 ±50ms 内敲击
  Then 判定为 PERFECT
  When 用户在 ±100ms 内敲击
  Then 判定为 GOOD
  When 用户在 ±150ms 外敲击或漏击
  Then 判定为 MISS

AC-006: 最近音符匹配
  Given 当前时间点附近有多个期望音符
  When 用户敲击
  Then 系统应在200ms窗口内查找最近音符
  And 只判定该音符一次

AC-007: 漏击自动检测
  Given 一个期望音符的时间已过
  When 超过150ms仍未检测到敲击
  Then 自动记录为 MISS
  And 重置Combo

AC-008: 判定视觉反馈
  Given 用户完成一次敲击
  When 判定为PERFECT/GOOD/MISS
  Then 对应鼓件显示绿色/绿色/红色闪烁动画
  And 屏幕中央显示判定文字(PERFECT/GOOD/MISS)
```

### AC-009 ~ AC-012: 评分系统
```gherkin
AC-009: 准确率计算
  Given 一次练习结束
  When 计算准确率
  Then 准确率 = (P×1.0 + G×0.7) / 总音符 × 100%
  And 结果四舍五入到整数

AC-010: Combo系统
  Given 练习进行中
  When 连续PERFECT或GOOD
  Then Combo数递增
  When 出现MISS
  Then Combo重置为0

AC-011: Combo加成
  Given Combo达到10/30/50/100
  When 显示当前Combo
  Then 同步显示加成倍数(×1.1/×1.2/×1.5/×2.0)
  And 视觉特效升级

AC-012: 评级系统
  Given 练习结束准确率X%
  When X >= 95
  Then 评级为S
  When X >= 85
  Then 评级为A
  When X >= 70
  Then 评级为B
  When X >= 50
  Then 评级为C
  When X < 50
  Then 评级为D
```

### AC-013 ~ AC-019: 视觉与存储
```gherkin
AC-013: 倒计时引导
  Given 用户开始练习
  When 点击"开始"
  Then 显示3-2-1-GO倒计时
  And 每个数字持续1秒
  And GO时练习正式开始

AC-014: 鼓点提示
  Given 练习进行中
  When 距离下一个音符500ms
  Then 对应鼓件显示黄色高亮提示
  And 提示持续到敲击时刻或错过

AC-015: 节拍器显示
  Given 4/4拍练习曲
  When 播放进行中
  Then 显示1-2-3-4节拍指示
  And 当前拍高亮显示

AC-016: 进度本地存储
  Given 用户完成练习
  When 获得新记录
  Then 自动保存到localStorage
  And 数据包含版本号、时间戳、各曲目进度
```

### AC-020 ~ AC-028: MP3上传与识别
```gherkin
AC-020: 文件上传
  Given 用户在MP3识别页面
  When 点击上传按钮
  Then 支持选择MP3/WAV文件
  And 文件大小限制20MB
  And 拒绝非音频文件并提示错误

AC-021: 音频解码
  Given 用户上传有效MP3
  When 文件读取完成
  Then 使用Web Audio API解码
  And 显示解码进度
  And 解码成功进入分析阶段

AC-022: 波形预览
  Given 音频解码成功
  When 显示波形图
  Then 波形可缩放、拖动
  And 支持选择起始/结束点
  And 选择范围限制30秒-全曲

AC-023: BPM检测
  Given 音频数据已加载
  When 运行BPM检测算法
  Then 返回检测到的BPM值
  And 置信度 > 0.8 时自动应用
  And 置信度 < 0.8 时提示用户手动输入

AC-024: Onset检测
  Given 音频数据和BPM
  When 运行onset检测
  Then 返回所有瞬态事件时间戳
  And 灵敏度可调(影响检测密度)

AC-025: 鼓点分类
  Given onset列表
  When 运行分类模型
  Then 每个onset标记为 Kick/Snare/HiHat/Crash/Tom/Other
  And 返回分类置信度

AC-026: 置信度过滤
  Given 分类结果
  When 应用阈值0.7
  Then 只保留置信度 >= 0.7 的检测
  And 低置信度标记为待确认

AC-027: 节奏网格对齐
  Given 检测到的鼓点时间
  When BPM已知
  Then 将鼓点对齐到最近的节拍网格
  And 对齐偏移不超过50ms

AC-028: 生成练习谱
  Given 过滤后的检测结果
  When 用户确认
  Then 生成符合TeachingRhythmMap格式的数据
  And 自动计算总音符数、时长
  And 保存到localStorage可立即练习
```

### AC-029 ~ AC-036: 识别结果处理
```gherkin
AC-029: 自动难度分级
  Given 生成的鼓谱
  When 计算音符密度
  Then 密度<50/分钟 = 简单
  And 50-100/分钟 = 中等
  And >100/分钟 = 困难

AC-030: 可视化编辑
  Given 识别结果页面
  When 显示时间轴
  Then 不同鼓件用不同颜色标记
  And 支持点击删除
  And 支持拖拽调整时间

AC-031: 手动添加鼓点
  Given 编辑模式
  When 用户在时间轴点击
  Then 弹出鼓件选择
  And 添加新音符到对应位置

AC-032: 保存与练习
  Given 编辑完成的谱面
  When 点击"保存并练习"
  Then 保存到localStorage
  And 自动跳转到教学模式
  And 加载该谱面开始练习
```

---

## 4. UI/UX Specifications

### 4.1 教学模式 - 练习曲列表
```
┌─────────────────────────────────────────┐
│  🥁 教学模式              [+]上传MP3   │
├─────────────────────────────────────────┤
│  📚 内置练习曲                          │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ 01      │ │ 02      │ │ 03      │   │
│  │ 基础四分 │ │ 简单交替 │ │ 入门摇滚 │   │
│  │ [S] 60  │ │ [A] 65  │ │ [B] 70  │   │
│  └─────────┘ └─────────┘ └─────────┘   │
│  ┌─────────┐ ┌─────────┐               │
│  │ 04 🔓   │ │ 05 🔒   │               │
│  │ 八分音符 │ │ 完成04  │               │
│  │ [-] 80  │ │ 解锁    │               │
│  └─────────┘ └─────────┘               │
├─────────────────────────────────────────┤
│  🎵 我的MP3 (3首)                      │
│  ┌─────────────────────────────────┐   │
│  │ 🎸 告白气球 - 周杰伦    [B] 85  │   │
│  │ 🥁 编辑  🗑️删除  ▶️练习          │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### 4.2 MP3识别 - 上传与分析
```
┌─────────────────────────────────────────┐
│  ← 返回      🎵 MP3鼓点识别            │
├─────────────────────────────────────────┤
│                                         │
│     ┌─────────────────────────────┐    │
│     │                             │    │
│     │     📁 点击或拖拽上传       │    │
│     │      MP3/WAV (最大20MB)     │    │
│     │                             │    │
│     └─────────────────────────────┘    │
│                                         │
├─────────────────────────────────────────┤
│  分析进度: [████████░░] 80%            │
│  1. 解码音频 ✓                         │
│  2. 检测BPM ✓ ( detected: 128 )        │
│  3. 检测鼓点 ⏳ ( found: 47 )          │
│  4. 分类鼓件 ⏳                         │
└─────────────────────────────────────────┘
```

### 4.3 MP3识别 - 结果编辑
```
┌─────────────────────────────────────────┐
│  🎵 告白气球    BPM: 128    [保存]     │
├─────────────────────────────────────────┤
│  波形 ▓▓▓▓▓▓░░▓▓▓▓▓▓▓▓▓▓░░▓▓▓▓▓▓▓▓    │
│  ───┬───┬───┬───┬───┬───┬───┬───┬───   │
│     │ ● │   │ ● │ ● │   │ ● │   │     │ Kick (●)
│  ───┼───┼───┼───┼───┼───┼───┼───┼───   │
│     │   │ ○ │   │   │ ○ │   │ ○ │     │ Snare (○)
│  ───┼───┼───┼───┼───┼───┼───┼───┼───   │
│  △  │   │   │ △ │   │   │ △ │   │     │ HiHat (△)
│  ───┴───┴───┴───┴───┴───┴───┴───┴───   │
│  0s   2s   4s   6s   8s  10s  12s      │
├─────────────────────────────────────────┤
│  检测统计: Kick:12 Snare:8 HiHat:24    │
│  [重新识别] [清空] [添加鼓点] [保存练习]│
└─────────────────────────────────────────┘
```

### 4.4 演奏界面 (教学模式)
```
┌─────────────────────────────────────────┐
│  🔥 24    准确率 ████████░░ 82%   ⏸️   │
│  告白气球  128 BPM    0:12/2:30        │
├─────────────────────────────────────────┤
│        ○ ○ ○ ●                         │
│        1 2 3 4                         │
│  ▓▓▓▓▓▓░░▓▓▓▓▓▓▓▓▓▓░░▓▓░░▓▓▓▓▓▓▓▓▓   │
├─────────────────────────────────────────┤
│   [Kick] [Snare] [HiHat] [Open]        │
│    🟢      ⚪      ⚪      ⚪           │
│                                         │
│   [Crash] [TomL] [TomM] [TomH]         │
│    ⚪      ⚪      ⚪      ⚪           │
└─────────────────────────────────────────┘
```

---

## 5. Success Metrics

### 5.1 教学模式
| Metric | Target | Measurement |
|--------|--------|-------------|
| 判定准确率 | >99% | 单元测试通过率 |
| 60fps保持率 | >95% | 演奏过程帧率监控 |
| 首次可交互 | <3s | Lighthouse |
| 离线可用性 | 100% | 无需网络请求 |

### 5.2 MP3识别
| Metric | Target | Measurement |
|--------|--------|-------------|
| 解码成功率 | >95% | 上传文件成功解码率 |
| BPM检测准确率 | >90% | 与真实BPM误差<5% |
| 鼓点检测召回率 | >80% | 人工标注对比 |
| 端到端处理时间 | <10s | 20MB文件从上传到可练习 |
| 分类准确率 | >75% | Kick/Snare/HiHat区分正确率 |

---

## 6. Appendix

### 6.1 练习曲清单

| 编号 | 曲名 | BPM | 难度 | 核心技巧 |
|-----|------|-----|------|---------|
| 01 | 基础四分音符 | 60 | ⭐ | 单鼓件节奏 |
| 02 | 简单交替 | 65 | ⭐ | 双鼓件配合 |
| 03 | 入门摇滚 | 70 | ⭐⭐ | 基础Rock Beat |
| 04 | 八分音符入门 | 80 | ⭐⭐ | Hi-Hat 8分音符 |
| 05 | 底鼓变化 | 85 | ⭐⭐ | Bass Drum Variation |
| 06 | 流行节奏 | 90 | ⭐⭐⭐ | Pop Groove |
| 07 | 加入 Tom | 100 | ⭐⭐⭐ | Tom Fill |
| 08 | 快速踩镲 | 110 | ⭐⭐⭐⭐ | Fast Hi-Hat |
| 09 | 复杂过门 | 115 | ⭐⭐⭐⭐ | Drum Fill |
| 10 | 大师挑战 | 120 | ⭐⭐⭐⭐⭐ | 综合技巧 |

### 6.2 相关文档
- Tech Spec V2: `v2/tech_spec.md`
- Task Spec V2: `v2/task_spec.md`
